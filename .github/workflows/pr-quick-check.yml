name: PR å¿«é€Ÿæ£€æŸ¥

on:
  pull_request:
    branches: [ main, develop ]

# å¿«é€Ÿæ£€æŸ¥ï¼Œ2-3åˆ†é’Ÿå†…å®Œæˆ
jobs:
  quick-check:
    name: ğŸš€ å¿«é€Ÿæ£€æŸ¥ï¼ˆLint + æ„å»ºï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      # åç«¯æ£€æŸ¥
      - name: ğŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ” åç«¯è¯­æ³•æ£€æŸ¥
        run: |
          pip install flake8 black
          cd backend
          # æ£€æŸ¥è¯­æ³•é”™è¯¯
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # æ£€æŸ¥ä»£ç æ ¼å¼
          black --check . || echo "ä»£ç æ ¼å¼å»ºè®®è¿è¡Œ: black ."
        continue-on-error: true
      
      # å‰ç«¯æ£€æŸ¥
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ” å‰ç«¯Lintæ£€æŸ¥
        run: |
          cd frontend
          npm run lint
      
      - name: ğŸ—ï¸ å‰ç«¯æ„å»ºæ£€æŸ¥
        run: |
          cd frontend
          npm run build
      
      - name: âœ… å¿«é€Ÿæ£€æŸ¥é€šè¿‡
        run: |
          echo "âœ… å¿«é€Ÿæ£€æŸ¥é€šè¿‡ï¼"
          echo "å®Œæ•´æµ‹è¯•å°†åœ¨åˆå¹¶åè‡ªåŠ¨è¿è¡Œ"

  # ç®€å•çš„APIå†’çƒŸæµ‹è¯•
  smoke-test:
    name: ğŸ”¥ å†’çƒŸæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: quick-check
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv sync
      
      - name: ğŸ”¥ å¯åŠ¨åç«¯å¹¶æµ‹è¯•
        run: |
          cd backend
          # åå°å¯åŠ¨
          uv run python app.py &
          SERVER_PID=$!
          
          # ç­‰å¾…å¯åŠ¨
          sleep 5
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:5000/health; then
            echo "âœ… åç«¯å†’çƒŸæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ åç«¯å†’çƒŸæµ‹è¯•å¤±è´¥"
            kill $SERVER_PID
            exit 1
          fi
          
          # æ¸…ç†
          kill $SERVER_PID
        env:
          GOOGLE_API_KEY: mock-key-for-testing
          TESTING: true

  pr-comment:
    name: ğŸ’¬ PRè¯„è®º
    runs-on: ubuntu-latest
    needs: [quick-check, smoke-test]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
      - name: è¯„è®ºPR
        uses: actions/github-script@v7
        with:
          script: |
            const quickCheck = '${{ needs.quick-check.result }}';
            const smokeTest = '${{ needs.smoke-test.result }}';
            
            let message = '## ğŸš€ å¿«é€Ÿæ£€æŸ¥ç»“æœ\n\n';
            
            if (quickCheck === 'success' && smokeTest === 'success') {
              message += 'âœ… **å¿«é€Ÿæ£€æŸ¥é€šè¿‡ï¼**\n\n';
              message += '- âœ… ä»£ç æ ¼å¼æ£€æŸ¥\n';
              message += '- âœ… æ„å»ºæ£€æŸ¥\n';
              message += '- âœ… å†’çƒŸæµ‹è¯•\n\n';
              message += 'å®Œæ•´çš„æµ‹è¯•å°†åœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯åè‡ªåŠ¨è¿è¡Œã€‚\n';
            } else {
              message += 'âŒ **å¿«é€Ÿæ£€æŸ¥å¤±è´¥**\n\n';
              message += `- ${quickCheck === 'success' ? 'âœ…' : 'âŒ'} ä»£ç æ ¼å¼æ£€æŸ¥\n`;
              message += `- ${smokeTest === 'success' ? 'âœ…' : 'âŒ'} å†’çƒŸæµ‹è¯•\n\n`;
              message += 'è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

